name: Render & Deploy to Cloudflare Pages

on:
  push:
    branches: [main, master]
    paths:
      - '**/*.md'
      - '**/*.py'
      - '**/*.html'
      - '!**.github/**'
  workflow_dispatch:
    inputs:
      exclude_folders:
        description: 'é€—å·åˆ†éš”çš„è¦æ’é™¤çš„æ–‡ä»¶å¤¹ï¼ˆç›¸å¯¹äºæ ¹ç›®å½•ï¼‰'
        required: false
        default: '.github,node_modules,__pycache__,dist,build'
  schedule:
    - cron: '0 0 * * *'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python and uv
        uses: astral-sh/setup-uv@v3
        with:
          python-version: '3.11'
          enable-cache: true
          cache-dependency-glob: 'pyproject.toml'

      - name: Install rendergit
        run: |
          uv tool install --from git+https://github.com/karpathy/rendergit
          echo "$(uv tool list | grep rendergit | awk '{print $2}')" >> $GITHUB_PATH

      - name: Determine excluded folders
        id: set-exclude
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            EXCLUDE_FOLDERS="${{ github.event.inputs.exclude_folders }}"
          else
            EXCLUDE_FOLDERS=".github,node_modules,__pycache__,dist,build,.git"
          fi
          echo "EXCLUDE_FOLDERS=${EXCLUDE_FOLDERS}" >> $GITHUB_ENV
          echo "exclude_folders=${EXCLUDE_FOLDERS}" >> $GITHUB_OUTPUT
          echo "ğŸ“ æ’é™¤çš„æ–‡ä»¶å¤¹: ${EXCLUDE_FOLDERS}"

      - name: Generate Static HTML with exclusions
        run: |
          mkdir -p ./dist
          
          # æ„å»º rendergit å‘½ä»¤å‚æ•°
          RENDER_ARGS="./ -o ./dist/index.html --no-open"
          
          # å¦‚æœæœ‰æ’é™¤ç›®å½•ï¼Œä½¿ç”¨è¿‡æ»¤
          if [[ -n "$EXCLUDE_FOLDERS" ]]; then
            echo "ğŸ“ ä½¿ç”¨æ’é™¤åˆ—è¡¨ç”ŸæˆHTMLï¼ˆæ’é™¤: $EXCLUDE_FOLDERSï¼‰"
            
            # åˆ›å»ºä¸´æ—¶å·¥ä½œåŒº
            TEMP_DIR=$(mktemp -d)
            echo "ä¸´æ—¶ç›®å½•: $TEMP_DIR"
            
            # å¤åˆ¶æ‰€æœ‰æ–‡ä»¶åˆ°ä¸´æ—¶ç›®å½•
            rsync -av --exclude='.git/' . "$TEMP_DIR/" > /dev/null 2>&1
            
            # ç§»é™¤æ’é™¤çš„æ–‡ä»¶å¤¹
            IFS=',' read -ra FOLDERS <<< "$EXCLUDE_FOLDERS"
            for folder in "${FOLDERS[@]}"; do
              folder_trimmed=$(echo "$folder" | xargs)
              if [[ -n "$folder_trimmed" ]]; then
                echo "ğŸš« æ’é™¤: $folder_trimmed"
                find "$TEMP_DIR" -name "$(basename "$folder_trimmed")" -type d -prune -exec rm -rf {} + 2>/dev/null || true
              fi
            done
            
            # ä»ä¸´æ—¶ç›®å½•ç”ŸæˆHTML
            cd "$TEMP_DIR"
            uv run rendergit . -o "$GITHUB_WORKSPACE/dist/index.html" --no-open
            cd "$GITHUB_WORKSPACE"
            rm -rf "$TEMP_DIR"
          else
            echo "ğŸ“ ç”Ÿæˆå®Œæ•´HTML"
            uv run rendergit $RENDER_ARGS
          fi
          
          # éªŒè¯ç”Ÿæˆç»“æœ
          if [[ ! -f ./dist/index.html ]]; then
            echo "âŒ HTML æ–‡ä»¶ç”Ÿæˆå¤±è´¥"
            exit 1
          fi
          
          echo "âœ… HTML æ–‡ä»¶ç”ŸæˆæˆåŠŸ"
          echo "ğŸ“Š æ–‡ä»¶å¤§å°: $(ls -lh ./dist/index.html | awk '{print $5}')"
          echo "ğŸ“„ æ–‡ä»¶è¡Œæ•°: $(wc -l < ./dist/index.html)"

      - name: Setup Cloudflare Wrangler
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}

      - name: Deploy to Cloudflare Pages
        env:
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          # æ£€æŸ¥å¹¶åˆ›å»ºé¡¹ç›®ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
          if ! wrangler pages project list 2>/dev/null | grep -q "rendergit-auto"; then
            echo "ğŸ†• åˆ›å»ºæ–°é¡¹ç›®: rendergit-auto"
            wrangler pages project create rendergit-auto --production-branch main 2>/dev/null || true
          fi
          
          # éƒ¨ç½²åˆ° Cloudflare Pages
          echo "ğŸš€ å¼€å§‹éƒ¨ç½²..."
          DEPLOY_OUTPUT=$(wrangler pages deploy ./dist \
            --project-name=rendergit-auto \
            --commit-dirty=true \
            --branch main 2>&1)
          
          echo "$DEPLOY_OUTPUT"
          
          # æå–éƒ¨ç½²URL
          if echo "$DEPLOY_OUTPUT" | grep -q "Successfully deployed"; then
            DEPLOY_URL=$(echo "$DEPLOY_OUTPUT" | grep -o 'https://[^ ]*\.pages\.dev' | head -1)
            if [[ -n "$DEPLOY_URL" ]]; then
              echo "âœ… éƒ¨ç½²å®Œæˆï¼"
              echo "ğŸŒ è®¿é—®åœ°å€: $DEPLOY_URL"
              echo "DEPLOY_URL=$DEPLOY_URL" >> $GITHUB_ENV
            fi
          fi

      - name: Create deployment summary
        if: always()
        run: |
          echo "## ğŸš€ éƒ¨ç½²ç»“æœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**çŠ¶æ€**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [[ -n "${{ env.DEPLOY_URL }}" ]]; then
            echo "**è®¿é—®åœ°å€**: [${{ env.DEPLOY_URL }}](${{ env.DEPLOY_URL }})" >> $GITHUB_STEP_SUMMARY
          else
            echo "**è®¿é—®åœ°å€**: æœªè·å–åˆ°éƒ¨ç½²URL" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**æ’é™¤çš„æ–‡ä»¶å¤¹**: \`${{ env.EXCLUDE_FOLDERS }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [[ -f ./dist/index.html ]]; then
            FILE_SIZE=$(ls -lh ./dist/index.html | awk '{print $5}')
            LINE_COUNT=$(wc -l < ./dist/index.html)
            echo "**ç”Ÿæˆæ–‡ä»¶**: \`dist/index.html\` (å¤§å°: $FILE_SIZE, è¡Œæ•°: $LINE_COUNT)" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**è§¦å‘æ–¹å¼**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "**æ‰‹åŠ¨è§¦å‘å‚æ•°**: ${{ github.event.inputs.exclude_folders }}" >> $GITHUB_STEP_SUMMARY
          fi
