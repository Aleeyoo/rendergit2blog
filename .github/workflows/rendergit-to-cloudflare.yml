name: Render & Deploy to Cloudflare Pages

on:
  push:
    branches: [main, master]
    paths:
      - '**/*.md'
      - '**/*.py'
      - '**/*.html'
      - '!**.github/**'
  workflow_dispatch:
    inputs:
      exclude_folders:
        description: 'é€—å·åˆ†éš”çš„è¦æ’é™¤çš„æ–‡ä»¶å¤¹ï¼ˆç›¸å¯¹äºæ ¹ç›®å½•ï¼‰'
        required: false
        default: '.github,node_modules,__pycache__,dist,build'
  schedule:
    - cron: '0 0 * * *'

env:
  UV_CACHE_DIR: ${{ runner.temp }}/uv-cache
  EXCLUDE_FOLDERS: ${{ github.event_name == 'workflow_dispatch' && inputs.exclude_folders || '.github,node_modules,__pycache__,dist,build,.git' }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python and uv with caching
        uses: astral-sh/setup-uv@v3
        with:
          python-version: '3.11'
          enable-cache: true
          cache-dependency-glob: 'pyproject.toml'

      - name: Install rendergit
        run: |
          uv tool install --from git+https://github.com/karpathy/rendergit
          echo "$(uv tool list | grep rendergit | awk '{print $2}')" >> $GITHUB_PATH

      - name: Prepare exclude directories
        run: |
          echo "EXCLUDE_FOLDERS=$EXCLUDE_FOLDERS" >> $GITHUB_ENV
          # åˆ›å»ºæ’é™¤ç›®å½•åˆ—è¡¨æ–‡ä»¶
          if [[ -n "$EXCLUDE_FOLDERS" ]]; then
            IFS=',' read -ra FOLDERS <<< "$EXCLUDE_FOLDERS"
            for folder in "${FOLDERS[@]}"; do
              folder_trimmed=$(echo "$folder" | xargs)
              if [[ -n "$folder_trimmed" && -d "$folder_trimmed" ]]; then
                echo "ğŸš« æ’é™¤ç›®å½•: $folder_trimmed"
                # åˆ›å»ºä¸´æ—¶å‰¯æœ¬ï¼Œæ’é™¤æŒ‡å®šç›®å½•
                find "$folder_trimmed" -type f | while read -r file; do
                  echo "$file" >> .excluded_files.txt
                done
              fi
            done
          fi

      - name: Generate Static HTML with exclusions
        run: |
          mkdir -p ./dist
          
          # æ„å»º rendergit å‘½ä»¤å‚æ•°
          RENDER_ARGS="./ -o ./dist/index.html --no-open"
          
          # å¦‚æœæœ‰æ’é™¤ç›®å½•ï¼Œä½¿ç”¨è¿‡æ»¤åçš„æ–‡ä»¶åˆ—è¡¨
          if [[ -f .excluded_files.txt ]]; then
            echo "ğŸ“ ä½¿ç”¨æ’é™¤åˆ—è¡¨ç”ŸæˆHTMLï¼ˆæ’é™¤ $(wc -l < .excluded_files.txt) ä¸ªæ–‡ä»¶ï¼‰"
            # åˆ›å»ºä¸´æ—¶ç›®å½•ç”¨äºè¿‡æ»¤
            TEMP_DIR=$(mktemp -d)
            cp -r ./* "$TEMP_DIR" 2>/dev/null || true
            
            # ç§»é™¤æ’é™¤çš„æ–‡ä»¶
            while read -r file; do
              if [[ -f "$file" ]]; then
                rm -f "$TEMP_DIR/${file#./}"
              fi
            done < .excluded_files.txt
            
            # ä»ä¸´æ—¶ç›®å½•ç”ŸæˆHTML
            uv run rendergit "$TEMP_DIR" -o ./dist/index.html --no-open
            rm -rf "$TEMP_DIR"
          else
            echo "ğŸ“ ç”Ÿæˆå®Œæ•´HTML"
            uv run rendergit $RENDER_ARGS
          fi
          
          # éªŒè¯ç”Ÿæˆç»“æœ
          if [[ ! -f ./dist/index.html ]]; then
            echo "âŒ HTML æ–‡ä»¶ç”Ÿæˆå¤±è´¥"
            exit 1
          fi
          
          echo "âœ… HTML æ–‡ä»¶ç”ŸæˆæˆåŠŸ"
          echo "ğŸ“Š æ–‡ä»¶å¤§å°: $(ls -lh ./dist/index.html | awk '{print $5}')"

      - name: Setup Cloudflare Wrangler
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}

      - name: Deploy to Cloudflare Pages
        env:
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          # æ£€æŸ¥å¹¶åˆ›å»ºé¡¹ç›®ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
          if ! wrangler pages project list | grep -q "rendergit-auto"; then
            echo "ğŸ†• åˆ›å»ºæ–°é¡¹ç›®: rendergit-auto"
            wrangler pages project create rendergit-auto --production-branch main
          fi
          
          # éƒ¨ç½²åˆ° Cloudflare Pages
          DEPLOY_OUTPUT=$(wrangler pages deploy ./dist \
            --project-name=rendergit-auto \
            --commit-dirty=true \
            --branch main)
          
          # æå–éƒ¨ç½²URL
          DEPLOY_URL=$(echo "$DEPLOY_OUTPUT" | grep -o 'https://[^ ]*\.pages\.dev')
          if [[ -n "$DEPLOY_URL" ]]; then
            echo "âœ… éƒ¨ç½²å®Œæˆï¼"
            echo "ğŸŒ è®¿é—®åœ°å€: $DEPLOY_URL"
            echo "DEPLOY_URL=$DEPLOY_URL" >> $GITHUB_ENV
          else
            echo "âš ï¸  æ— æ³•æå–éƒ¨ç½²URLï¼ŒåŸå§‹è¾“å‡º:"
            echo "$DEPLOY_OUTPUT"
          fi

      - name: Create deployment summary
        if: always()
        run: |
          echo "## ğŸš€ éƒ¨ç½²ç»“æœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**çŠ¶æ€**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [[ -n "$DEPLOY_URL" ]]; then
            echo "**è®¿é—®åœ°å€**: [$DEPLOY_URL]($DEPLOY_URL)" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**æ’é™¤çš„æ–‡ä»¶å¤¹**: \`${{ env.EXCLUDE_FOLDERS }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [[ -f ./dist/index.html ]]; then
            echo "**ç”Ÿæˆæ–‡ä»¶**: \`dist/index.html\` ($(ls -lh ./dist/index.html | awk '{print $5}'))" >> $GITHUB_STEP_SUMMARY
          fi
